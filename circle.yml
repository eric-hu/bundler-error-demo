experimental:
  picard:
    version: 0.1
    executorType: docker
    containerInfo:
      - image: justincampbell/capybara-webkit:2.3
      - image: postgres:9.4.1
        env:
          - POSTGRES_USER=ubuntu
    stages:
      build:
        workDir: /home/ubuntu/canary-rails
        environment:
          RACK_ENV: "test"
        steps:
          - type: checkout
          #  Need to start Xvfb explicitly for headless webkit integration tests
          - type: shell
            command: DISPLAY=":99" Xvfb :99 -screen 0 1280x1024x24
            background: true
            name: Starting Xvfb (for Webkit)

          # should probably move into container image
          - type: shell
            command: |
              apt-get update
              apt-get install -y nodejs
              gem install bundler
              mkdir -p /tmp/artifacts

          # Create Postgres users and database, shows how to use a YAML heredoc
          # to provide nicer formatting
          - type: shell
            shell: /bin/bash
            command: |
              bundle install

          - type: shell
            shell: /bin/bash
            command: |
              echo 'test:
                database: circle_ruby_test
                adapter: postgresql
                pool: 5
                timeout: 5000
                username: ubuntu
                host: localhost
              ' > config/database.yml && \
              bundle exec rake db:create db:schema:load

          - type: shell
            command: |
              bundle exec rspec --color --require spec_helper --format RspecJunitFormatter --out /tmp/artifacts/rspec.xml --format progress
            #environment:
              #SSH_TARGET: "localhost"
              #TEST_ENV: "linux"

          # Save artifacts
          - type: artifacts-store
            path: /tmp/artifacts
            destination: build
